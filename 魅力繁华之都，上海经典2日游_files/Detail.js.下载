define([
    'gsRootView',
    'gsRouterRedirect',
    'gsCommon',
    'gsCommonGeolocation',
    'gsAppAgent',
    'cUtilCryptBase64',
    'gsJourneyDetailModel',
    'cMemberService'
], function(
    pageView,
    RouterRedirect,
    gsCommon,
    CommonGeolocation,
    appAgent,
    cUtilCryptBase64,
    gsJourneyDetailModel,
    Member
) {
    var detailView = pageView.extend({
        
        
       
        onCreate: function(){
            this.pageid= Lizard.P("isFromWeixinApp") ? 10650038641 : Lizard.P("isFromToutiaoApp") ? 10650038661 : Lizard.P("isFromQuickApp") ? 10650011644 : 10650016599;
            this.hpageid= 10650016596; //hybrid的pageid
            this.offsetTopList= [];
            this.statusBarHeight= 0;
            this.blockingWakeupflag= false;
            this.getRecommendProducts = gsJourneyDetailModel.GetRecommendProducts.getInstance();
            this.recommendData={};
            this.recommendCount=0;
            this.recommendTmpl= _.template(Lizard.T('recommendTmpl'));
            this.isWinXinApp= Lizard.P("isFromWeixinApp") ? true : false;
            this.isTouTiaoApp= Lizard.P("isFromToutiaoApp") ? true : false;
            this.isQuickApp= Lizard.P("isFromQuickApp") ? true : false;
            this.isNavBarWhite = true;
        },
        
        onAppear:function(){
            this.header.hide();
            if (Lizard.isHybrid || Lizard.isInCtripApp) {
                CtripUtil.app_set_status_bar_style("lightContent");

                if (appAgent.isAndroid() && appAgent.compareAppVersion("8.7") < 1) {
                    CtripBar.appSetTransparentForWindow();
                    CtripBar.setLightStatusBar(false);
                }
            }
        },

        onShow: function () {
            var self = this;
            var ids = [{ sID: 353693 }, { sID: 353694 }, { sID: 353696 }, { sID: 353698 }, { sID: 353699 }, { sID: 353700 }, { sID: 353701 }, { sID: 353703 }, { sID: 353704 }, { sID: 447459 }, { sID: 450748 }];
            self._gs_super();

            self.blockingWakeupWrap();

            if (Lizard.isHybrid || Lizard.isInCtripApp) {
                if (appAgent.isAndroid() && appAgent.compareAppVersion("8.7") < 1) {
                    CtripBar.appGetStatusBarHeight(function (result) {

                        self.statusBarHeight = parseInt(result) / 2;
                        self.$('.js_page_header_first').css({ 'padding-top': self.statusBarHeight }); 
                        self.$('.js_page_header').css({ 'padding-top': self.statusBarHeight, 'background-color':'#ffffff'});
                        self.$('.js_menu_shade').css({'padding-top': 78 + self.statusBarHeight});
                    });
                }
            };

            $("title").html(self.datas.schedule.title);
            $('body').css({'overflow':'hidden'})
            $('#headerview').hide();
            this.bindAction();
            this.initShowMore();

            this.districtId = Lizard.P('districtId');
            this.scheduleInfoId = Lizard.P('scheduleInfoId');
            this.addTraceLog({
                'actioncode': 'page_browse',
                'actiontype': 'browse',
                'districtid': this.districtId,
                'routeid': this.scheduleInfoId
            });    

        
            //document.title = '【携程攻略】' + this.$el.find('.detail_title').text();
            if(this.isWinXinApp){
                //微信小程序中 不知道是不是还有引入微信sdk 引入再说
                require(['//res.wx.qq.com/open/js/jweixin-1.3.2.js'], function (wx) {
                    window.wx = wx;
                    var url = window.location.href;
                    var title = this.$('.shareParmas').data('title');
                    var desc = this.$('.shareParmas').data('description'); 
                    wx.miniProgram.postMessage({
                        data: {
                            shareData: {
                                bu: 'gs',
                                title: title,
                                path: `/cwx/component/cwebview/cwebview?data=${
                                    JSON.stringify({       
                                        needLogin: false,
                                        url: encodeURIComponent(url),
                                    })
                                }`,
                                desc: desc,
                                // imageUrl: '这是分享图',
                            },
                            type: 'onShare'
                        }
                    });
                })
            }

            if(this.isTouTiaoApp){
                //头条小程序中 不知道是不是还有引入头条jssdk 引入再说
                require(['//s3.pstatp.com/toutiao/tmajssdk/jssdk-1.0.1.js'], function (tt) {
                })
            }

            if(this.isQuickApp){
                //新版快应用的JS-SDK是自动注入的，不需要此引用
                require(['https://pages.c-ctrip.com/amsweb/quickApp/mixBridge.js'], function (WeixinJSBridge) {
                })
            }
            if (appAgent.isWeixinBrowser()) {
                if (typeof WeixinJSBridge === 'undefined') {
                    document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
                        // alert(JSON.stringify(WeixinJSBridge))
                        if (typeof WeixinJSBridge !== 'undefined') {
                            self.weixinShare();
                        }
                    }, false);
                } else {
                    self.weixinShare();
                }
            }

            this.$el.find('.js_unfold').click(function(e){
                var $current = $(e.currentTarget);
                $current.removeClass('folded');
                e.stopPropagation(); 
            })

            gsCommon._getAidAndSid(function (data) {
                data = data || {};
                var sid = data.SID;
                if (!!sid) {
                    ids.map(function (v, k) {
                        if (v.sID == sid) {
                            self.blockingWakeupflag = true
                        }
                    });
                }
            });

            // if (Lizard.isInCtripApp && !(appAgent.compareAppVersion("8.3") < 1)){
            //     self.$('.js_edit').css({'display':'none'})
            // }

            if (Lizard.isHybrid || Lizard.isInCtripApp) {
                CtripUtil.app_set_status_bar_style("lightContent");
            }

            // __bfi.push(['_getStatus', function(data){
            //     var vid = data.vid;
            //     CommonGeolocation.startPosition(function (data) {
            //         var lat = data.lat;
            //         var lng = data.lng;
            //         self._getRecommendProducts(vid, lat, lng);
            //     }, function () {
            //         //console.log('经纬度获取失败')
            //         var lat = null;
            //         var lng = null;
            //         self._getRecommendProducts(vid, lat, lng);
            //     });
            // }]);  
            __bfi.push(['_getStatus', function(data){
                var vid = data.vid;
                if (typeof window['__union'] === 'undefined') {
                    window['__union'] = [];
                }
                window['__union'].push({"callback":function(){
                    var unionMktStr = window.localStorage.getItem("UNION"), data;
                    if(!!unionMktStr){
                        data = JSON.parse(unionMktStr).data || {};
                    }
                    if(!!data && data.AllianceID == 838439){
                        var lat = null;
                        var lng = null;
                        self._getRecommendProducts(vid, lat, lng);
                    }else{
                        CommonGeolocation.startPosition(function (data) {
                            var lat = data.lat;
                            var lng = data.lng;
                            self._getRecommendProducts(vid, lat, lng);
                        }, function () {
                            //console.log('经纬度获取失败')
                            var lat = null;
                            var lng = null;
                            self._getRecommendProducts(vid, lat, lng);
                        });
                    }
                }})
            }]);  
            
        },

        events: {
            "click .js_nav_menu": 'slideDownMenu',
            "click .js_close_menu": 'closeMenu',
            "click .js_menu_pick": 'pickDay',
            "click .js_check_route": 'showRoute',
            "click .js_close_route": 'closeRouteModal',
            "click .js_jump_url": 'redirectUrl',
            "click .js_go_back": 'goBack',
            "click .js_to_map": 'goToMap',
            "click .js_menu_shade": 'cancelModal',
            "click .js_edit": 'goToEdit',
            "click .js_add_itinerary": 'addItinerary',
            "click .js_book_route": 'bookRoute',
            "click .js_imme_book": 'immeBook',
            "click .js_free_plan": 'freePlan', 
            "click .js_iconfont_close": 'iconfontClose',
            "click .js_more_productlink": 'jsMoreProductLink',
            "click .js_book_btn": 'jsBookBtn',
            "click .js_seo_click": 'jsSeoClick',
        },

        _getRecommendProducts: function(vid, lat, lng){
            var self = this;
            var districtId = Lizard.P('districtId');
            var scheduleInfoId = Lizard.P('scheduleInfoId');
            self.getRecommendProducts.setParam({
                scheduleInfoId : scheduleInfoId,
                districtId : districtId,
                latLng: {lat:lat, lng: lng},
                vid:vid,
            });
            self.getRecommendProducts.excute(function (data) {
                self.recommendData = data;
                self.recommendCount = data && data.recommendProducts && data.recommendProducts[0] && data.recommendProducts[0].items && data.recommendProducts[0].items.length;
                var html = ''; 

                if(self.recommendCount>=2){
                    html = self.recommendTmpl({
                        recommendData: self.recommendData,
                        recommendCount: self.recommendCount,
                        isWinXinApp:self.isWinXinApp,
                        isQuickApp:self.isQuickApp
                    });
                    //小程序下展示底部bar
                   if(self.isWinXinApp || self.isQuickApp) $('.js_detail_footer').show()
                    self.$(".js_recommend").append(html);
                }else{
                    //小程序下不展示底部bar时 调整底部距离
                    if(self.isWinXinApp || self.isQuickApp) $('.js_top_scroller').css('padding-bottom',0)
                }

                if(self.isTouTiaoApp){
                    $('.js_top_scroller').css('padding-bottom',0)
                }
                

            }, function (error) {
                console.log('相关推荐获取失败')
            })

        },

        addTraceLog: function(params){
            gsCommon.cTrackLog(100088, params);
        },

        jsSeoClick: function(e){
            e.preventDefault();
        },

        jsMoreProductLink: function (e) {
           var $curDom = $(e.currentTarget),
               url = $curDom.data('url'),
               scheduleInfoId = Lizard.P('scheduleInfoId'),
               targetModel = 2;

            if(url.indexOf("ctrip://wireless") > -1){
                targetModel = 1;
            }

            RouterRedirect.toJump({
                url: [url,url],
                targetModel: targetModel
            });

            this.addTraceLog({
                'actioncode': 'c_route_buy_recommendation_travel_more',
                'actiontype': 'click',
                'routeid': scheduleInfoId
            }); 
        },

        jsBookBtn: function (e) {
            var $curDom = $(e.currentTarget),
                url = $curDom.data('url'),
                productId = $curDom.data('id'),
                index = $curDom.data('index'),
                scheduleInfoId = Lizard.P('scheduleInfoId'),
                targetModel = 2;
                
            if(url.indexOf("ctrip://wireless") > -1){
                targetModel = 1;
            }

            RouterRedirect.toJump({
                url: [url,url],
                targetModel: targetModel
            });

            this.addTraceLog({
                'actioncode': 'c_route_buy_recommendation_travel',
                'actiontype': 'click',
                'routeid': scheduleInfoId,
                'index': index,
                'productid': productId
            });

        },

        blockingWakeupWrap: function () {
            var self = this;
            var css = '<style>.blocking_wakeup_box{position:fixed;z-index:999;width:100%;left:0;right:0;bottom:0;}.blocking_wakeup_box .blocking_close_blk{position:relative;height:80px;background-image:linear-gradient(180deg,rgba(255,255,255,0.00) 0%,rgba(255,255,255,0.39) 39%,#FFFFFF 100%)}.blocking_wakeup_box .blocking_close_blk .blocking_close_btn{position:absolute;bottom:0;left:50%;margin-left:-11px;display:block;width:23px;height:24px;background-image:url("https://pages.c-ctrip.com/you/itinerary/blockingwakeup_icon.png");background-size:23px auto;background-repeat:no-repeat}.blocking_wakeup_box .blocking_wakeup_area{background:#fff;padding:16px 12px;border-width: 0;border-top: 1px solid #c8c8c8;-webkit-border-image: url("https://pages.c-ctrip.com/you/common/icon_border_half_lightgray.png") 2 stretch;border-image: url("https://pages.c-ctrip.com/you/common/icon_border_half_lightgray.png") 2 stretch;}.blocking_wakeup_box .blocking_wakeup_area .blocking_wakeup_btn{display:block;line-height:44px;font-family:PingFangSC-Medium;font-size:17px;color:#FFF;text-align:center;background:#0086F6;border-radius:6px}</style>'
            var html = '<div class="blocking_wakeup_box" style="display:none;">' +
                '  <div class="blocking_close_blk">' +
                '  <span class="blocking_close_btn"></span>' +
                '  </div>' +
                '  <div class="blocking_wakeup_area">' +
                '  <span class="blocking_wakeup_btn">去 App 内查看完整行程</span>' +
                '  </div>' +
                '  </div>';
            var blockingawak_bar = css + html;
            $('#main').prepend(blockingawak_bar);
            $('.blocking_wakeup_btn').on('click', function () {
                Lizard._gs_awkeup_();
            });
            $('.blocking_close_btn').on('click', function () {
                $('body').find('.blocking_wakeup_box').remove();
                self.$('.top_scroller').css({ 'overflow-y': 'auto' });
            })
        },

        awakenMode: function (url) {
            if (!Lizard.isHybrid && !Lizard.isInCtripApp) { // 如果当前是app环境,则没必要做任何事情
                if (typeof window["__wakeup"] === "undefined") {
                    window["__wakeup"] = [];
                }
                window["__wakeup"].push({
                    'url': url, //必传可以传空,  此处是 http地址,例 http://m.ctrip.com/html5, 一般填你当前的url
                    'isdown': true, //必传  唤醒失败是否需要下载，true需要下载。false不下载
                })
            }

        },

        //编辑线路
        goToEdit: function (){
            var districtId = parseInt(Lizard.P('districtId')),
                scheduleInfoId = parseInt(Lizard.P('scheduleInfoId')),
                detailUrl = 'ctrip://wireless/h5?type=5&url=' + cUtilCryptBase64.Base64.encode('/rn_destination_journey/main.js?CRNModuleName=rn_destination_journey&CRNType=1&initialPage=detailPage&scheduleInfoId=' + scheduleInfoId + '&districtId=' + districtId),
                editUrl = 'ctrip://wireless/h5?type=5&url=' + cUtilCryptBase64.Base64.encode('/rn_destination_journey/main.js?CRNModuleName=rn_destination_journey&CRNType=1&initialPage=editPage&scheduleId=' + scheduleInfoId + '&scheduleType=0&isEdit=1');
            if (Lizard.isInCtripApp){
                if (appAgent.compareAppVersion("8.3") < 1) {

                    //强制登录
                    if (!Member.isLogin()) {
                        Member.memberLogin({
                            param: "from=" + encodeURIComponent(window.location.href),
                            callback: function () {
                                if (Member.isLogin()) {
                                    RouterRedirect.toJump({
                                        "url": ['', editUrl],
                                        "targetModel": 1,
                                    });
                                }
                            }
                        });
                        return;
                    }else{
                        RouterRedirect.toJump({
                            "url": ['', editUrl],
                            "targetModel": 1,
                        });
                    }
                    
                }
                
            }else{
                this.awakenMode(detailUrl);
            }
        },

        //加入行程
        addItinerary: function (){
            var districtId = parseInt(Lizard.P('districtId')),
                scheduleInfoId = parseInt(Lizard.P('scheduleInfoId')),
                crnUrl = 'ctrip://wireless/h5?type=5&url=' + cUtilCryptBase64.Base64.encode('/rn_destination_journey/main.js?CRNModuleName=rn_destination_journey&CRNType=1&initialPage=detailPage&scheduleInfoId=' + scheduleInfoId + '&districtId=' + districtId);
            this.awakenMode(crnUrl);
        },

        bookRoute: function (e) {
            var self = this,
                $curDom = $(e.currentTarget),
                redirects = parseInt($curDom.data('redirects'));
            if (redirects > 1) {
                self.$('.js_default_itinerary').hide();
                self.$('.js_choice_itinerary').addClass('slideUp');
            } else {
                var url = $curDom.data('redirect');

                RouterRedirect.toJump({
                    "url": [url, url],
                    "targetModel": 2,
                });
            }
        },

        immeBook: function (e) {
            var $curDom = $(e.currentTarget),
                url = $curDom.data('url');

            RouterRedirect.toJump({
                "url": [url, url],
                "targetModel": 2,
            });
        },

        freePlan: function (e) {
            var $curDom = $(e.currentTarget),
                url = $curDom.data('url');

            RouterRedirect.toJump({
                "url": [url, url],
                "targetModel": 2,
            });
        },

        iconfontClose: function (e) {
            var self = this;

            self.$('.js_choice_itinerary').removeClass('slideUp');
            self.$('.js_default_itinerary').show();
        },

        bindAction: function(){
            // 滚动事件捕捉
            var self = this;
            var dayMark = self.$el.find('.js_day_mark');
            var dayColumn = self.$el.find('.section_column');
            var dayLeng = dayMark.length;
            var $dayNavBar = self.$el.find('.js_day_nav');
            var poiCardLength = $('.poi_card').length;
            for(var t=0; t<dayLeng; t++){
                self.offsetTopList.push(dayMark[t].offsetTop);
            }
            self.offsetTopList.push(dayMark[dayLeng-1].offsetTop + dayColumn[dayLeng-1].getBoundingClientRect().height);

            $(".top_scroller").off("scroll").on("scroll", function(e){
                self.headerFixeTop();	

                // day吸顶
                var st = $(".top_scroller").scrollTop() + 74;
                var scrollHeight = $('.top_scroller').scrollTop();
                var blockingLen = $('.blocking_wakeup_box').length;
                var poiCardHeight = $('.poi_card').height();
                var blockingHeight = $('.blocking_wakeup_box').height();
                var poiCardTop = $('.poi_card').eq(1).offset().top;
                var topHeight = poiCardHeight / 3 + blockingHeight; 

                for(var m=0; m<dayLeng; m++) {
                    if(st>=self.offsetTopList[m] && st<self.offsetTopList[m+1]) {  
                        $dayNavBar.html('<div class="header_name">'+ dayMark.eq(m).html()+'</div>'+'<div class="menu" id="c_route_contents">目录</div>');
                        $dayNavBar.data('index', m);
                    }
                }
                if(st < self.offsetTopList[0]){
                    $dayNavBar.html('')
                }

                //阻断式唤醒
                if ((self.blockingWakeupflag || Lizard.P('blockingwakeup') == 1) && poiCardLength > 2 && scrollHeight >= (poiCardTop - topHeight) && blockingLen > 0) {
                    $('.blocking_wakeup_box').show();
                    self.$('.top_scroller').css({ 'overflow-y': 'hidden' });
                }else {
                    self.$('.top_scroller').css({ 'overflow-y': 'auto' });
                }
            });
        },

        headerFixeTop: function(){
            var top = $(".top_scroller").scrollTop(),
            $pageHeaderFirst = $(".js_page_header_first"),
            $pageHeader = $(".js_page_header"),
            routeMapY = $('.js_body_map').offset().top,
            pageHeaderH = $pageHeaderFirst.height();
            $pageHeader.show();
            if(this.isWinXinApp || this.isTouTiaoApp || this.isQuickApp) $('.js_detail_header').hide();
            $pageHeaderFirst.css({
                opacity: 0
            });
            if(top <= 0){
                $pageHeaderFirst.css({
                    opacity: 1
                });
                $pageHeader.css({
                    display: 'none'
                });
                if (Lizard.isHybrid || Lizard.isInCtripApp && !this.isNavBarWhite) {
                    CtripUtil.app_set_status_bar_style("lightContent");
                    CtripBar.appSetTransparentForWindow();
                }
                this.isNavBarWhite = true;
            } else {
                $pageHeaderFirst.css({
                    opacity: 0
                });
                $pageHeader.css({
                    opacity: top / pageHeaderH < 1 ? top / pageHeaderH : 1,
                    'padding-top': this.statusBarHeight
                });
                if (Lizard.isHybrid || Lizard.isInCtripApp && this.isNavBarWhite) {
                    CtripUtil.app_set_status_bar_style("darkContent");
                    if (appAgent.isAndroid() && appAgent.compareAppVersion("8.7") < 1) {
                        CtripBar.appSetStatusBarColor('#ffffff', 1);
                        CtripBar.setLightStatusBar(true);
                    }
                }
                this.isNavBarWhite = false;
            }
            if(routeMapY < 44){
                this.$el.find('.js_header_map').show();
            }else{
                this.$el.find('.js_header_map').hide();
            }
        },

        initShowMore: function () {
            $(".js_poi_intro").each(function () {
                if ($(this).height() < $(this).children('span').height()) {
                    // 需压缩
                    $(this).addClass('folded');
                }else{
                    $(this).removeClass('folded');
                }
            })
        },

        goBack: function(){
            RouterRedirect.toBack();
        },

        goToMap: function(typeday){
            // var url=window.location.origin + '/webapp/you/journeys/'+ this.districtId +'/'+ this.scheduleInfoId +'-map.html?hideBrandTip=1&maptype=undefind-0&from=' + encodeURIComponent(window.location.href)
            //var url= Lizard.appBaseUrl + '/journeys/'+ this.districtId +'/'+ this.scheduleInfoId +'-map.html?hideBrandTip=1&maptype=undefind-0&from=' + encodeURIComponent(window.location.href)
            var url= window.location.origin + '/webapp/you/journeys/'+ this.districtId +'/'+ this.scheduleInfoId +'-map.html?hideBrandTip=1&maptype=undefind-0&from=' + encodeURIComponent(window.location.href)
            RouterRedirect.toJump({
                "url": [url, url],
                "targetModel": 2,
            });
        },

        weixinShare: function () {
            //微信分享
            var _this = this;
            var shareInfo = {
                title: document.title,
                content: '在携程攻略发现了个超赞的路线，快来看看吧~',
                shareUrl: window.location.href,
                picUrl: this.datas.schedule.coverImageUrl
            };
            
            WeixinJSBridge.on('menu:share:appmessage', function (argv) {
                WeixinJSBridge.invoke('sendAppMessage', {
                    "img_url": shareInfo.picUrl,
                    "img_width": "200",
                    "img_height": "200",
                    "link": shareInfo.shareUrl,
                    'desc': shareInfo.content,
                    "title": shareInfo.title
                }, function (res) { })
            });

            WeixinJSBridge.on('menu:share:timeline', function (argv) {
                WeixinJSBridge.invoke('shareTimeline', {
                    "img_url": shareInfo.picUrl,
                    "img_width": "200",
                    "img_height": "200",
                    "link": shareInfo.shareUrl,
                    'desc': shareInfo.content,
                    "title": shareInfo.title
                }, function (res) { });
            });
            
            WeixinJSBridge.on('menu:share:weibo', function (argv) {
                WeixinJSBridge.invoke('shareWeibo', {
                    "content": shareInfo.title + shareInfo.content,
                    'url': shareInfo.shareUrl
                }, function (res) { });
            });
        },

        slideDownMenu: function(e){
            var currentIndex = $(e.currentTarget).data('index');
            this.$el.find('.js_menu_list').show();
            this.$el.find('.js_page_header').addClass('modal');
            this.$el.find('.js_menu_list .menu_item').eq(currentIndex).addClass('active').siblings().removeClass('active');
            this.$el.find('.top_scroller').css({'overflow-y': 'hidden'});
            if(this.isWinXinApp || this.isTouTiaoApp || this.isQuickApp) {
                this.$el.find('.header-space').css({'padding-top': '34px'});
            }
        },

        closeMenu: function(){
            this.$el.find('.js_menu_list').hide();
            this.$el.find('.js_page_header').removeClass('modal');
            this.$el.find('.top_scroller').css({'overflow-y': 'auto'});
        },

        pickDay: function(e){
            var self = this,
            currentIndex = $(e.currentTarget).index(),
            dayMark = this.$el.find('.js_day_mark');
            dayMark[currentIndex].scrollIntoView({
                block: "start",
                behavior: "smooth"
            });
            setTimeout(function(){
                $('.top_scroller').scrollTop(self.offsetTopList[currentIndex]-44);
            },300)
            this.closeMenu();
        },

        showRoute:function(){
            this.$el.find('.js_whole_route').show();
        },

        closeRouteModal: function(){
            this.$el.find('.js_whole_route').hide();
        },

        redirectUrl: function(e){
                         
            var $current = $(e.currentTarget),
            type = $current.data('type'),
            url = $current.data('url');
            //小程序跳转
            if(this.isWinXinApp){
                if($current.hasClass('poi_card')){
                    //景点详情页
                    var id = url.match(/\/([\d]+).html/)[1]
                    if(type == 3){
                        url = "/pages/gs/sight/newDetail?sightId=" + id
                    }else if(type == 2){
                        //美食详情页
                        var districtId = url.match(/\/([\d]+)\//)[1]
                        url = "/pages/foods/resDetail/resDetail?id=" + id + '&districtId=' + districtId
                    } else if(type == 50){
                        //酒店详情页
                        url = "/pages/hotel/detail/index?id=" + id
                    }else return;

                }else{
                    if(url.indexOf('hotel/city')>=0 || url.indexOf('hotel/oversea/city')>=0){
                        //海外或者国内 酒店列表
                        var hotelid = url.match(/\/city([\d]*)\//)[1]
                        url = "/pages/hotel/list/index?cityid=" + hotelid + '&keyword=' + $current.data('zonename') +'&biz=' + (url.indexOf('hotel/city')>=0 ? 1:2)
                        //美食小程序只配了150个目的地 暂时都不跳 
                    // }else if(url.indexOf('/foods/')>=0){
                    //     var id = url.match(/\/([\d]+).html/)[1]
                    //     url = "/pages/foods/home/home?districtId=" + id
                    }else return
                }
                wx.miniProgram.navigateTo({
                    url: url
                });
                return;
            }
            if(this.isTouTiaoApp || this.isQuickApp) {
                if($current.hasClass('poi_card')){
                    //景点详情页
                    var id = url.match(/\/([\d]+).html/)[1]
                    if(type == 3){
                        url = "/pages/gs/sight/detail?sightId=" + id
                    }else if(type == 50){
                        //酒店详情页
                        url = "/pages/hotel/detail/index?id=" + id
                    }else return;

                }else{
                    if(url.indexOf('hotel/city')>=0 || url.indexOf('hotel/oversea/city')>=0){
                        //海外或者国内 酒店列表
                        var hotelid = url.match(/\/city([\d]*)\//)[1]
                        url = "/pages/hotel/list/index?cityid=" + hotelid + '&cityname=' + $current.data('zonename') +'&biz=1'
                    }else return
                }
                if(this.isTouTiaoApp) {
                    tt.miniProgram.navigateTo({
                        url: url
                    });
                }

                if(this.isQuickApp) {
                    window.qa.navigateTo({url: url})
                } 
                
                return;
            }
            if($current.hasClass('poi_card')){
                this.addTraceLog({
                    'actioncode': 'c_route_poi',
                    'actiontype': 'click',
                    'poiid': $current.data('id'),
                    'poitype':$current.data('type'),
                    'routeid': this.scheduleInfoId,
                    'isdesexist':$current.data('intro')
                }); 
            }
            concatIcon = url.indexOf('?')>0 ? '&': '?';
            url = url + concatIcon + 'from=' + encodeURIComponent(window.location.href);
            // 接口返回的url会根据环境给H5或hybrid链接，个别poi类型在APP内也只有H5链接
            RouterRedirect.toJump({
                url: [url, url],
                targetModel: (Lizard.isHybrid || Lizard.isInCtripApp) && url.indexOf('ctrip://')==0 ? 1 : 2
            });

        },

        unfoldDescription: function(e){
            var $current = $(e.currentTarget);
            $current.parent().removeClass('folded');
            e.stopPropagation(); //未能阻止冒泡
        },


        cancelModal: function(e){
            var _con = $('.js_menu_pick');
            if(!$(e.currentTarget).hasClass('js_menu_pick') && _con.has(e.target).length === 0){
                this.closeMenu();
            }
        }

    });
    return detailView;
});